<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <title>Phone Upside-Down Detector</title>
        <style>
            :root {
                --bg: #0b0b0c;
                --fg: #f5f7fa;
                --muted: #9aa3b2;
                --ok: #10b981;
                --bad: #ef4444;
            }
            html,
            body {
                height: 100%;
                margin: 0;
                background: var(--bg);
                color: var(--fg);
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Inter,
                    Arial,
                    sans-serif;
            }
            .wrap {
                min-height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 24px;
            }
            .card {
                width: min(720px, 92vw);
                border-radius: 20px;
                padding: 28px;
                background: rgba(255, 255, 255, 0.05);
                box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
                text-align: center;
            }
            .title {
                font-size: 13px;
                letter-spacing: 0.14em;
                text-transform: uppercase;
                color: var(--muted);
                margin-bottom: 8px;
            }
            .status {
                font-size: 48px;
                font-weight: 800;
                margin: 6px 0 10px;
            }
            .status.ok {
                color: var(--ok);
            }
            .status.bad {
                color: var(--bad);
            }
            .sub {
                color: var(--muted);
                margin-bottom: 18px;
            }
            .grid {
                display: grid;
                gap: 10px;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            .kv {
                background: rgba(255, 255, 255, 0.06);
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 14px;
                padding: 12px;
            }
            .k {
                font-size: 12px;
                color: var(--muted);
                text-transform: uppercase;
                letter-spacing: 0.08em;
            }
            .v {
                font-family: ui-monospace, Menlo, Consolas, monospace;
                margin-top: 6px;
            }
            .btn {
                margin-top: 16px;
                padding: 12px 16px;
                border-radius: 12px;
                border: 0;
                cursor: pointer;
                background: #2563eb;
                color: #fff;
                font-weight: 700;
            }
            .note {
                margin-top: 10px;
                color: var(--muted);
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <div class="card">
                <div class="title">Orientation</div>
                <div id="status" class="status">Waiting…</div>
                <div id="sub" class="sub">
                    Rotate your phone to test. On iPhone you may need to tap the
                    button below.
                </div>

                <div class="grid">
                    <div class="kv">
                        <div class="k">Upside Down</div>
                        <div class="v" id="vUpside">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">Method</div>
                        <div class="v" id="vMethod">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">Screen Type</div>
                        <div class="v" id="vType">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">Screen Angle</div>
                        <div class="v" id="vAngle">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">Accel X</div>
                        <div class="v" id="vX">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">Accel Y</div>
                        <div class="v" id="vY">—</div>
                    </div>
                    <div class="kv">
                        <div class="k">Accel Z</div>
                        <div class="v" id="vZ">—</div>
                    </div>
                </div>

                <button id="permBtn" class="btn" style="display: none">
                    Enable motion access
                </button>
                <div class="note">
                    Requires a mobile browser. Motion sensors usually need
                    HTTPS.
                </div>
            </div>
        </div>

        <script>
            (function () {
                const UI =
                    typeof document !== "undefined" && document.getElementById
                        ? {
                              set(payload) {
                                  const s = document.getElementById("status");
                                  const sub = document.getElementById("sub");
                                  const vUpside =
                                      document.getElementById("vUpside");
                                  const vMethod =
                                      document.getElementById("vMethod");
                                  const vX = document.getElementById("vX");
                                  const vY = document.getElementById("vY");
                                  const vZ = document.getElementById("vZ");
                                  if (!s) return;
                                  s.textContent = payload.is_upside_down
                                      ? "Upside Down"
                                      : "Normal";
                                  s.className =
                                      "status " +
                                      (payload.is_upside_down ? "bad" : "ok");
                                  if (sub)
                                      sub.textContent =
                                          "Detected via accelerometer";
                                  if (vUpside)
                                      vUpside.textContent = String(
                                          payload.is_upside_down,
                                      );
                                  if (vMethod)
                                      vMethod.textContent = "accelerometer";
                                  if (vX)
                                      vX.textContent =
                                          payload.accel_x.toFixed(2);
                                  if (vY)
                                      vY.textContent =
                                          payload.accel_y.toFixed(2);
                                  if (vZ)
                                      vZ.textContent =
                                          payload.accel_z.toFixed(2);
                              },
                              needPerm() {
                                  const s = document.getElementById("status");
                                  const sub = document.getElementById("sub");
                                  if (s) {
                                      s.textContent = "Permission needed";
                                      s.className = "status";
                                  }
                                  if (sub)
                                      sub.textContent =
                                          "Enable motion access and rotate your phone.";
                              },
                          }
                        : { set() {}, needPerm() {} };

                // --- Android: no special permission API, but site-level "Motion sensors" must be allowed.
                // We'll still keep the iOS check so this works cross-platform.
                function needsIOSPermission() {
                    return (
                        typeof DeviceMotionEvent !== "undefined" &&
                        typeof DeviceMotionEvent.requestPermission ===
                            "function"
                    );
                }
                async function ensurePermission() {
                    if (!needsIOSPermission()) return true;
                    try {
                        return (
                            (await DeviceMotionEvent.requestPermission()) ===
                            "granted"
                        );
                    } catch {
                        return false;
                    }
                }

                // Auto-calibration: learn which sign means "upright" on this device
                let baselineY = null; // average Y during first second
                let samples = 0;
                const CALIBRATION_MS = 1000;
                let startTime = Date.now();

                // Thresholds
                const MAG_MIN = 4.0; // magnitude gate to ensure we’re really portraitish
                const FLIP_DELTA = 6.0; // how far from baseline to call it flipped

                let lastRender = 0;
                function maybeRender(p) {
                    const now = Date.now();
                    if (now - lastRender > 120) {
                        lastRender = now;
                        UI.set(p);
                    }
                }

                function decideUpside(y, x) {
                    // If we couldn't calibrate yet, use sign-based heuristic
                    const portraitish =
                        Math.abs(y) > Math.abs(x) && Math.abs(y) > MAG_MIN;
                    if (!portraitish) return false;

                    if (baselineY == null) {
                        // Heuristic before baseline: most Androids report upright ≈ +9 or −9; treat "more negative than −T" as upside.
                        return y < -MAG_MIN;
                    }
                    // Upside if we’ve crossed to the other side of baseline by a healthy margin
                    return baselineY > 0
                        ? y < baselineY - FLIP_DELTA
                        : y > baselineY + FLIP_DELTA;
                }

                ensurePermission().then(function (granted) {
                    if (!granted && needsIOSPermission()) {
                        UI.needPerm();
                        return;
                    }

                    window.addEventListener(
                        "devicemotion",
                        function (ev) {
                            const g = ev.accelerationIncludingGravity;
                            if (!g) return;
                            const x = g.x || 0,
                                y = g.y || 0,
                                z = g.z || 0;

                            // Build baseline for ~1s
                            if (
                                baselineY === null &&
                                Date.now() - startTime < CALIBRATION_MS
                            ) {
                                // only accumulate when portraitish to avoid sideways bias
                                if (
                                    Math.abs(y) > Math.abs(x) &&
                                    Math.abs(y) > MAG_MIN
                                ) {
                                    samples++;
                                    baselineY =
                                        baselineY === null
                                            ? y
                                            : (baselineY * (samples - 1) + y) /
                                              samples;
                                }
                            }

                            const isUpside = decideUpside(y, x);

                            maybeRender({
                                is_upside_down: !!isUpside,
                                accel_x: x,
                                accel_y: y,
                                accel_z: z,
                            });
                        },
                        { passive: true },
                    );
                });
            })();
        </script>
    </body>
</html>
